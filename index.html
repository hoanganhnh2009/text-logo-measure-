<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ƒêo chi·ªÅu r·ªông ch·ªØ + logo</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        max-width: 1000px;
        margin: auto;
        background: #f8f9fa;
        color: #333;
      }
      input,
      select,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        font-size: 14px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      select {
        height: 60px;
      }
      canvas {
        margin-top: 15px;
        border: 1px dashed #ccc;
        width: 100%;
        height: 150px;
        background: linear-gradient(#eee 2.5cm, #fff 2.5cm);
      }
      #output {
        margin-top: 12px;
        font-size: 14px;
        white-space: pre-wrap;
      }
      label {
        display: block;
        margin-top: 15px;
        font-weight: 600;
        color: #444;
      }
      h2 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #1a1a1a;
      }
      button {
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
        background: #f0f0f0;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
      }
      .row input[type="file"] {
        flex: 1;
      }
      .row button {
        padding: 6px 12px;
        font-size: 14px;
        flex-shrink: 0;
        width: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: #e7e7e7;
        border-radius: 6px;
        color: #444;
      }
      .row button:hover {
        background: #dcdcdc;
      }
      .material-icons {
        font-size: 18px;
      }
      #logoPreview img {
        margin-top: 10px;
        display: block;
        max-height: 100px;
        object-fit: contain;
      }
      #cableLength {
        height: auto !important;
        padding: 6px 10px;
      }
    </style>
  </head>
  <body>
    <h2>üÖ∞Ô∏è ƒêo chi·ªÅu r·ªông ch·ªØ + logo</h2>

    <div class="row">
      <div style="flex: 2">
        <input id="text" placeholder="Nh·∫≠p ch·ªØ c·∫ßn ƒëo" value="L√™ Vi·∫øt Ho√®" />
      </div>
      <div style="flex: 1">
        <input
          id="height"
          type="number"
          step="0.1"
          placeholder="Chi·ªÅu cao (cm)"
          value="3"
          max="5"
        />
      </div>
    </div>

    <label>üî§ Font (Google & t√πy ch·ªânh)</label>
    <div class="row" style="align-items: stretch">
      <div style="flex: 2; display: flex; flex-direction: column; gap: 5px">
        <input
          id="fontSearch"
          placeholder="T√¨m font Google..."
          autocomplete="off"
        />
        <select id="fontList" size="6"></select>
      </div>
      <div style="flex: 1; display: flex; flex-direction: column; gap: 5px">
        <input type="file" id="fontFile" accept=".ttf,.otf" />
        <button id="clearFont" title="X√≥a font">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>

    <label>üñºÔ∏è Logo (·∫£nh PNG/JPG/SVG)</label>
    <div class="row">
      <input type="file" id="logoFile" accept="image/*" />
      <button id="clearLogo" title="X√≥a logo">
        <span class="material-icons">close</span>
      </button>
    </div>

    <canvas id="canvas" width="800" height="150"></canvas>
    <div id="output"></div>
    <div id="logoPreview"></div>
    <!-- <div class="row">
      <div style="flex: 1">
        <label>üìè Lo·∫°i d√¢y</label>
        <select id="cableLength">
          <option value="2">2 m√©t</option>
          <option value="3" selected>3 m√©t</option>
          <option value="5">5 m√©t</option>
        </select>
      </div>
      <div style="flex: 2">
        <div id="cableSuggest" style="padding-top: 8px; font-weight: 600"></div>
        <div
          id="spacingOptions"
          style="color: #333; font-size: 13px; margin-top: 10px"
        ></div>
      </div>
    </div> -->

    <div class="row" style="align-items: center; gap: 12px">
      <label for="cableLength" style="font-weight: bold; white-space: nowrap"
        >üìè Lo·∫°i d√¢y</label
      >
      <select id="cableLength" style="width: auto">
        <option value="2">2 m√©t</option>
        <option value="3" selected>3 m√©t</option>
        <option value="5">5 m√©t</option>
      </select>
    </div>
    <div
      id="spacingOptions"
      style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px"
    ></div>
    <div class="row" style="align-items: flex-start">
      <div style="flex: 1">
        <label>S·ªë l·∫ßn in / d√¢y</label>
        <input type="number" id="printsPerCable" value="1" min="1" />
      </div>
      <div style="flex: 1">
        <label>S·ªë d√¢y c·∫ßn in</label>
        <input type="number" id="numberOfCables" value="1" min="1" />
      </div>
      <div style="flex: 1">
        <label>Chi ph√≠ c·ªë ƒë·ªãnh</label>
        <input value="200000" />
      </div>
    </div>

    <div id="priceOutput" style="margin-top: 12px; font-weight: bold"></div>

    <script>
      const API_KEY = "AIzaSyArOSMGtMYlBfaI9EcLd9WvT21zYTAaYfU";
      const allFonts = [];
      let uploadedFontName = "";
      let logoWidthCm = 0;
      const pxPerInch = 96;
      const cmPerInch = 2.54;
      const pxPerCm = pxPerInch / cmPerInch;

      const fontList = document.getElementById("fontList");
      const output = document.getElementById("output");
      const fontSearch = document.getElementById("fontSearch");
      const textInput = document.getElementById("text");
      const heightInput = document.getElementById("height");
      const printsPerCableInput = document.getElementById("printsPerCable");
      const numberOfCablesInput = document.getElementById("numberOfCables");
      const priceOutput = document.getElementById("priceOutput");

      async function fetchFonts() {
        try {
          output.innerText = "üîÑ ƒêang t·∫£i danh s√°ch font...";
          const res = await fetch(
            `https://www.googleapis.com/webfonts/v1/webfonts?key=${API_KEY}`
          );
          const json = await res.json();
          const systemFonts = [
            "Arial",
            "Times New Roman",
            "Helvetica",
            "Tahoma",
            "Verdana",
            "Calibri",
            "Georgia",
            "Impact",
            "Franklin Gothic",
            "Segoe UI",
          ];
          allFonts.push(...systemFonts, ...json.items.map((f) => f.family));
          // output.innerText = `‚úÖ ƒê√£ t·∫£i ${allFonts.length} fonts`;
          filterFonts();
        } catch (err) {
          output.innerText = `‚ùå L·ªói t·∫£i font: ${err.message}`;
        }
      }

      function filterFonts() {
        const query = fontSearch.value.toLowerCase();
        fontList.innerHTML = "";
        const found = allFonts
          .filter((f) => f.toLowerCase().includes(query))
          .slice(0, 50);
        found.forEach((font) => {
          const opt = document.createElement("option");
          opt.textContent = font;
          fontList.appendChild(opt);
        });
      }

      fontList.addEventListener("change", () => {
        fontSearch.value = fontList.value;
        measure();
      });
      fontSearch.addEventListener("input", filterFonts);
      textInput.addEventListener("input", measure);
      heightInput.addEventListener("input", () => {
        measure();
        resizeLogo();
      });
      printsPerCableInput.addEventListener("input", measure);
      numberOfCablesInput.addEventListener("input", measure);

      document
        .getElementById("fontFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function () {
            const fontData = reader.result;
            const font = new FontFace("UploadedFont", fontData);
            font
              .load()
              .then(function (loadedFace) {
                document.fonts.add(loadedFace);
                uploadedFontName = "UploadedFont";
                output.innerText = `‚úÖ Font "${file.name}" ƒë√£ t·∫£i l√™n.`;
                measure();
              })
              .catch(function (err) {
                output.innerText = `‚ùå L·ªói t·∫£i font: ${err}`;
              });
          };
          reader.readAsArrayBuffer(file);
        });

      document.getElementById("clearFont").addEventListener("click", () => {
        uploadedFontName = "";
        document.getElementById("fontFile").value = "";
        output.innerText = "üßπ ƒê√£ x√≥a font upload.";
        measure();
      });
      document
        .getElementById("cableLength")
        .addEventListener("change", measure);

      document
        .getElementById("logoFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function () {
            const img = new Image();
            img.onload = function () {
              const cm = parseFloat(heightInput.value) || 2;
              const targetHeightPx = cm * pxPerCm;
              const ratio = img.width / img.height;
              const targetWidthPx = targetHeightPx * ratio;
              logoWidthCm = targetWidthPx / pxPerCm;

              img.style.height = `${targetHeightPx}px`;
              img.style.width = `${targetWidthPx}px`;
              img.style.objectFit = "contain";

              const preview = document.getElementById("logoPreview");
              preview.innerHTML = "";
              preview.appendChild(img);

              measure();
            };
            img.src = reader.result;
          };
          reader.readAsDataURL(file);
        });

      document.getElementById("clearLogo").addEventListener("click", () => {
        document.getElementById("logoFile").value = "";
        document.getElementById("logoPreview").innerHTML = "";
        logoWidthCm = 0;
        measure();
      });

      function measure() {
        const text = textInput.value.trim();
        const cm = parseFloat(heightInput.value);
        const selectedFont = fontList.value;
        const usingUploaded = !!uploadedFontName;
        const font = usingUploaded ? uploadedFontName : selectedFont || "Arial";

        if (!text || !cm || cm <= 0) {
          output.innerText = "‚ùó Vui l√≤ng nh·∫≠p ch·ªØ v√† chi·ªÅu cao h·ª£p l·ªá.";
          clearCanvas();
          return;
        }

        if (!usingUploaded && selectedFont) {
          loadGoogleFont(selectedFont);
        }

        const pt = cm * 28.3464567;
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const pxFontHeight = cm * pxPerCm;

        const scale = 0.7;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();

        ctx.scale(scale, scale);
        ctx.textBaseline = "alphabetic";
        ctx.font = `${pt}pt '${font}'`;
        ctx.fillStyle = "#000";

        const textX = 10;
        const textY = pxFontHeight;
        //

        ctx.fillText(text, textX, textY);

        const textMetrics = ctx.measureText(text);
        const textWidth = textMetrics.width;
        const widthCm = textWidth / pxPerCm;
        const textHeight = pxFontHeight;
        const textBottom = textY + 5;

        ctx.strokeStyle = "#4a90e2";
        ctx.lineWidth = 1;
        ctx.strokeRect(textX, textY - textHeight, textWidth, textHeight);
        ctx.beginPath();
        ctx.moveTo(textX, textBottom);
        ctx.lineTo(textX + textWidth, textBottom);
        ctx.stroke();
        ctx.fillStyle = "#4a90e2";
        ctx.font = `normal 14px sans-serif`;
        ctx.fillText(
          `${widthCm.toFixed(1)} cm`,
          textX + textWidth / 2 - 30,
          textBottom + 15
        );

        let totalCm = widthCm;

        if (logoWidthCm > 0) {
          const logoStartX = textX + textWidth + 10;
          const logoWidthPx = logoWidthCm * pxPerCm;
          const logoHeight = pxFontHeight;

          ctx.strokeStyle = "#d35400";
          ctx.lineWidth = 1;
          ctx.strokeRect(
            logoStartX,
            textY - logoHeight,
            logoWidthPx,
            logoHeight
          );

          ctx.beginPath();
          ctx.moveTo(logoStartX, textBottom);
          ctx.lineTo(logoStartX + logoWidthPx, textBottom);
          ctx.stroke();

          ctx.fillStyle = "#d35400";
          ctx.fillText(
            `${logoWidthCm.toFixed(1)} cm`,
            logoStartX + logoWidthPx / 2 - 30,
            textBottom + 15
          );

          totalCm += logoWidthCm;
        }

        ctx.fillStyle = "#c0392b";
        ctx.font = `bold 16px sans-serif`;
        ctx.fillText(
          `üìê T·ªïng: ${totalCm.toFixed(1)} cm üìè Ch·ªØ: ${widthCm.toFixed(1)} cm
                 ${
                   logoWidthCm > 0
                     ? `üñºÔ∏è Logo: ${logoWidthCm.toFixed(1)} cm`
                     : ""
                 }`,
          textX,
          textBottom + 40
        );
        ctx.restore();

        // output.innerHTML =
        //   `üñã Font: ${
        //     usingUploaded ? "Font t·∫£i l√™n" : selectedFont || "Arial"
        //   }<br>` +
        //   `üìè Ch·ªØ: ${widthCm.toFixed(2)} cm` +
        //   (logoWidthCm > 0 ? `<br>üñºÔ∏è Logo: ${logoWidthCm.toFixed(2)} cm` : "") +
        //   `<br><b style="font-size:16px;color:#d91e18;">üìê T·ªïng: ${totalCm.toFixed(
        //     2
        //   )} cm</b>`;
        const cableLength = parseFloat(
          document.getElementById("cableLength").value
        ); // m√©t
        // Ch·ªâ c·ªë ƒë·ªãnh 1 ƒë·∫ßu 20cm = 0.2m, + 20cm c√°ch ƒëu√¥i (ƒêi·ªÉm cu·ªëi)
        const reservedEnds = 0.2 + 0.2;
        const usableLength = cableLength - reservedEnds;

        const minSpacing = 20 / 100; // m√©t
        const maxSpacing = 60 / 100;
        const totalCmEach = totalCm / 100; // m√©t cho 1 l·∫ßn in (g·ªìm ch·ªØ + logo)

        let minCount = Math.floor(usableLength / (totalCmEach + maxSpacing));
        let maxCount = Math.floor(usableLength / (totalCmEach + minSpacing));

        // Ch·ªët ch·ªçn s·ªë l·∫ßn in t·ª± ƒë·ªông l√† trung b√¨nh gi·ªØa min & max
        let autoCount = Math.floor((minCount + maxCount) / 2);
        if (autoCount < 1) autoCount = 1;

        // T√≠nh kho·∫£ng c√°ch gi·ªØa c√°c l·∫ßn in
        const spacing =
          ((usableLength - autoCount * totalCmEach) / (autoCount - 1 || 1)) *
          100; // cm
        let min = minCount > 0 ? minCount - 1 : minCount;
        let max = maxCount > 0 ? maxCount + 1 : maxCount;
        console.log("min", min, max);
        const spacingOptions = Array.from(
          { length: max - min + 1 },
          (_, i) => i + min
        )
          .map((count) => {
            const space =
              ((usableLength - count * totalCmEach) / (count - 1 || 1)) * 100;
            // Kho·∫£ng c√°ch min 20cm, max 40cm
            if (space < 20 || space > 70) return null;
            return `<div class="spacing-suggestion" data-count="${count}" title="B·∫•m ƒë·ªÉ ch·ªçn"
        style="
          cursor: pointer;
          padding: 6px 10px;
          border: 1px dashed #999;
          border-radius: 8px;
          background: #fff;
          white-space: nowrap;
          font-size: 13px;
          box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
          transition: 0.2s ease-in-out;
        ">
        üìç <b>${count}</b> l·∫ßn ~ <b>${space.toFixed(1)}cm</b>
      </div>`;
          })
          .filter(Boolean)
          .join("<br>");

        document.getElementById("spacingOptions").innerHTML =
          "<div>üìå G·ª£i √Ω kho·∫£ng c√°ch in:</div><br>" + spacingOptions;
        document.querySelectorAll(".spacing-suggestion").forEach((el) =>
          el.addEventListener("click", () => {
            const count = parseInt(el.dataset.count);
            printsPerCableInput.value = count;
            measure();
          })
        );
        // end
        // `üñã Font: ${
        // usingUploaded ? "Font t·∫£i l√™n" : selectedFont || "Arial"
        //}<br>` +
        // output.innerHTML =
        //   `üìè Ch·ªØ: ${widthCm.toFixed(1)} cm` +
        //   (logoWidthCm > 0 ? `<br>üñºÔ∏è Logo: ${logoWidthCm.toFixed(1)} cm` : "") +
        //   `<br><b style="font-size:16px;color:#d91e18;">`;
        output.innerHTML = ``;

        updatePrintCost(totalCm);
      }

      function updatePrintCost(totalCm) {
        const priceFix = 200000;
        const printsPerCable = parseInt(printsPerCableInput.value) || 0;
        const numberOfCables = parseInt(numberOfCablesInput.value) || 0;
        const price = totalCm > 30 ? 10000 : 5000;
        const total = printsPerCable * numberOfCables * price + priceFix;

        priceOutput.innerHTML = `
                üí∏ Gi√° in: ${price.toLocaleString()}ƒë
            <br/>üîÅ T·ªïng in: ${printsPerCable} x ${numberOfCables} = <b>${
          printsPerCable * numberOfCables
        }</b><br>
                üßæ <b style="color: red;">T·ªïng ti·ªÅn :\r ${total.toLocaleString()}ƒë</b>
                <div style="font-size:12px;font-weight:normal;font-style:italic;color:#6b6b6b">(= Gi√° in * S·ªë l·∫ßn in / d√¢y * s·ªë d√¢y c·∫ßn in + chi ph√≠ c·ªë ƒë·ªãnh)</div>
              `;
      }

      function resizeLogo() {
        const logo = document.querySelector("#logoPreview img");
        if (!logo) return;
        const cm = parseFloat(heightInput.value) || 2;
        const targetHeightPx = cm * pxPerCm;
        const ratio = logo.naturalWidth / logo.naturalHeight;
        const targetWidthPx = targetHeightPx * ratio;
        logo.style.height = `${targetHeightPx}px`;
        logo.style.width = `${targetWidthPx}px`;
        logoWidthCm = targetWidthPx / pxPerCm;
        measure();
      }

      function loadGoogleFont(font) {
        const fontName = font.replace(/ /g, "+");
        if (
          ![...document.head.querySelectorAll("link")].some((link) =>
            link.href.includes(`family=${fontName}`)
          )
        ) {
          const link = document.createElement("link");
          link.href = `https://fonts.googleapis.com/css2?family=${fontName}&display=swap`;
          link.rel = "stylesheet";
          document.head.appendChild(link);
        }
      }

      function clearCanvas() {
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      window.onload = function () {
        fetchFonts();
        measure();
      };
    </script>
  </body>
</html>
